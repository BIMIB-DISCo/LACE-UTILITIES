# set the working directory
setwd("/data_directory/BimiB/share/LACE/MELANOMA/real_data")

# load required scripts
library("parallel")
library("Rfast")
source("R/frontend.R")
source("R/inference.R")

# load data
load("final_LACE_input_data/D.RData")

# define likelihood weights
lik_w1 = (1-(dim(D[[1]])[1]/(dim(D[[1]])[1]+dim(D[[2]])[1]+dim(D[[3]])[1]+dim(D[[4]])[1])))
lik_w2 = (1-(dim(D[[2]])[1]/(dim(D[[1]])[1]+dim(D[[2]])[1]+dim(D[[3]])[1]+dim(D[[4]])[1])))
lik_w3 = (1-(dim(D[[3]])[1]/(dim(D[[1]])[1]+dim(D[[2]])[1]+dim(D[[3]])[1]+dim(D[[4]])[1])))
lik_w4 = (1-(dim(D[[4]])[1]/(dim(D[[1]])[1]+dim(D[[2]])[1]+dim(D[[3]])[1]+dim(D[[4]])[1])))
lik_w = c(lik_w1,lik_w2,lik_w3,lik_w4)
lik_w = lik_w/sum(lik_w)

# define parameters for grid search

alpha1 = list(c(0.001,0.001,0.001,0.001))
alpha2 = list(c(0.002,0.001,0.001,0.001))
alpha3 = list(c(0.001,0.002,0.001,0.001))
alpha4 = list(c(0.001,0.001,0.002,0.001))
alpha5 = list(c(0.001,0.001,0.001,0.002))
alpha6 = list(c(0.001,0.001,0.001,0.001))
alpha7 = list(c(0.002,0.001,0.001,0.001))
alpha8 = list(c(0.001,0.002,0.001,0.001))
alpha9 = list(c(0.001,0.001,0.002,0.001))
alpha10 = list(c(0.001,0.001,0.001,0.002))
alpha11 = list(c(0.01,0.01,0.01,0.01))
alpha12 = list(c(0.02,0.01,0.01,0.01))
alpha13 = list(c(0.01,0.02,0.01,0.01))
alpha14 = list(c(0.01,0.01,0.02,0.01))
alpha15 = list(c(0.01,0.01,0.01,0.02))
alpha16 = list(c(0.01,0.01,0.01,0.01))
alpha17 = list(c(0.02,0.01,0.01,0.01))
alpha18 = list(c(0.01,0.02,0.01,0.01))
alpha19 = list(c(0.01,0.01,0.02,0.01))
alpha20 = list(c(0.01,0.01,0.01,0.02))
alpha21 = list(c(0.05,0.05,0.05,0.05))
alpha22 = list(c(0.10,0.05,0.05,0.05))
alpha23 = list(c(0.05,0.10,0.05,0.05))
alpha24 = list(c(0.05,0.05,0.10,0.05))
alpha25 = list(c(0.05,0.05,0.05,0.10))
alpha26 = list(c(0.05,0.05,0.05,0.05))
alpha27 = list(c(0.10,0.05,0.05,0.05))
alpha28 = list(c(0.05,0.10,0.05,0.05))
alpha29 = list(c(0.05,0.05,0.10,0.05))
alpha30 = list(c(0.05,0.05,0.05,0.10))

beta1 = list(c(0.001,0.001,0.001,0.001))
beta2 = list(c(0.002,0.001,0.001,0.001))
beta3 = list(c(0.001,0.002,0.001,0.001))
beta4 = list(c(0.001,0.001,0.002,0.001))
beta5 = list(c(0.001,0.001,0.001,0.002))
beta6 = list(c(0.01,0.01,0.01,0.01))
beta7 = list(c(0.02,0.01,0.01,0.01))
beta8 = list(c(0.01,0.02,0.01,0.01))
beta9 = list(c(0.01,0.01,0.02,0.01))
beta10 = list(c(0.01,0.01,0.01,0.02))
beta11 = list(c(0.001,0.001,0.001,0.001))
beta12 = list(c(0.002,0.001,0.001,0.001))
beta13 = list(c(0.001,0.002,0.001,0.001))
beta14 = list(c(0.001,0.001,0.002,0.001))
beta15 = list(c(0.001,0.001,0.001,0.002))
beta16 = list(c(0.01,0.01,0.01,0.01))
beta17 = list(c(0.02,0.01,0.01,0.01))
beta18 = list(c(0.01,0.02,0.01,0.01))
beta19 = list(c(0.01,0.01,0.02,0.01))
beta20 = list(c(0.01,0.01,0.01,0.02))
beta21 = list(c(0.01,0.01,0.01,0.01))
beta22 = list(c(0.02,0.01,0.01,0.01))
beta23 = list(c(0.01,0.02,0.01,0.01))
beta24 = list(c(0.01,0.01,0.02,0.01))
beta25 = list(c(0.01,0.01,0.01,0.02))
beta26 = list(c(0.05,0.05,0.05,0.05))
beta27 = list(c(0.10,0.05,0.05,0.05))
beta28 = list(c(0.05,0.10,0.05,0.05))
beta29 = list(c(0.05,0.05,0.10,0.05))
beta30 = list(c(0.05,0.05,0.05,0.10))

alpha = c(alpha1,alpha2,alpha3,alpha4,alpha5,alpha6,alpha7,alpha8,alpha9,alpha10,alpha11,alpha12,alpha13,alpha14,alpha15,alpha16,alpha17,alpha18,alpha19,alpha20,alpha21,alpha22,alpha23,alpha24,alpha25,alpha26,alpha27,alpha28,alpha29,alpha30)
beta = c(beta1,beta2,beta3,beta4,beta5,beta6,beta7,beta8,beta9,beta10,beta11,beta12,beta13,beta14,beta15,beta16,beta17,beta18,beta19,beta20,beta21,beta22,beta23,beta24,beta25,beta26,beta27,beta28,beta29,beta30)

# perform inference
inference = LACE(D=D,lik_w=lik_w,alpha=alpha,beta=beta,num_rs=100,num_iter=50000,n_try_bs=1000,marginalize=FALSE,num_processes=30,seed=12345,verbose=TRUE)

# save the results
save(inference,file="results/inference.RData")
